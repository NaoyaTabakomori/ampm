<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>„Å©„Éº„Åì„Å†Ôºü„Ç¢„É≥„Éë„É≥„Éû„É≥</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:#ff7700;
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;
  font-family:'Zen Maru Gothic',sans-serif;
  overflow:hidden;
}
.frame{
  position:relative;
  width:min(98vw,860px);
  aspect-ratio:16/10;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 0 0 5px #ffdd00,0 0 0 12px #ff6600,0 10px 50px rgba(0,0,0,.6);
}
.frame::before{
  content:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
  position:absolute;top:0;left:0;right:0;
  font-size:clamp(10px,1.8vw,15px);letter-spacing:clamp(6px,1.8vw,16px);
  text-align:center;pointer-events:none;z-index:60;padding:2px 0;opacity:.8;
}
.frame::after{
  content:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
  position:absolute;bottom:0;left:0;right:0;
  font-size:clamp(10px,1.8vw,15px);letter-spacing:clamp(6px,1.8vw,16px);
  text-align:center;pointer-events:none;z-index:60;padding:2px 0;opacity:.8;
}
.scene{width:100%;height:100%;position:relative;overflow:hidden;}
.bg-img{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:cover;pointer-events:none;z-index:0;
}
.char{
  position:absolute;cursor:pointer;z-index:10;
  -webkit-tap-highlight-color:transparent;
  transition:transform .12s;
}
.char img{
  width:100%;height:auto;display:block;
  pointer-events:none;
}
.char:hover{transform:scale(1.1);z-index:20;}
.char:active{transform:scale(0.92);}
.char.correct img{
  filter:drop-shadow(0 0 10px #ffee00) drop-shadow(0 0 24px #ff8800);
}
.hud-timer{
  position:absolute;top:4%;left:2%;z-index:50;
  background:#f5e040;border:4px solid #cc8800;border-radius:14px;
  padding:4px 12px 5px;box-shadow:3px 3px 0 #996600;
  text-align:center;min-width:18%;
}
.timer-label{font-size:clamp(7px,1.4vw,12px);color:#883300;font-weight:700;letter-spacing:.05em;}
.timer-row{display:flex;align-items:baseline;justify-content:center;gap:3px;}
.timer-num{font-size:clamp(22px,5.5vw,50px);font-weight:900;color:#cc2200;line-height:1;}
.timer-unit{font-size:clamp(8px,1.4vw,12px);color:#883300;font-weight:700;}
.timer-num.warn{animation:warn-flash .4s infinite;}
@keyframes warn-flash{0%,100%{color:#cc2200}50%{color:#ff9900}}
.hud-score{
  position:absolute;top:30%;left:2%;z-index:50;
  background:#3399ff;border:3px solid #0055cc;border-radius:10px;
  padding:3px 10px;color:#fff;font-size:clamp(9px,1.8vw,15px);font-weight:900;
  box-shadow:2px 2px 0 #003388;
}
.hud-stage{
  position:absolute;bottom:3%;right:2%;z-index:50;
  color:#fff;font-size:clamp(8px,1.4vw,13px);font-weight:700;
  text-shadow:1px 1px 0 rgba(0,0,0,.6);
  background:rgba(0,0,0,.4);padding:3px 10px;border-radius:20px;
}
.hud-target{
  position:absolute;top:2%;right:2%;z-index:50;
  background:#fff;border:5px solid #dd2200;border-radius:16px;
  padding:8px 8px 4px;box-shadow:3px 3px 0 #880000;
  display:flex;flex-direction:column;align-items:center;
  min-width:16%;
}
.target-bubble{
  position:absolute;top:-17px;left:50%;transform:translateX(-50%);
  background:#ffdd00;border:3px solid #dd2200;border-radius:18px;
  padding:2px 10px;font-size:clamp(9px,1.8vw,14px);font-weight:900;color:#cc0000;
  white-space:nowrap;box-shadow:2px 2px 0 #880000;
}
.target-bubble::after{
  content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
  border:5px solid transparent;border-top-color:#dd2200;
}
.target-preview{
  width:clamp(44px,8vw,80px);height:clamp(44px,8vw,80px);
  display:flex;align-items:center;justify-content:center;
}
.target-preview img{width:100%;height:100%;object-fit:contain;}
.target-name{font-size:clamp(7px,1.4vw,12px);font-weight:900;color:#cc0000;margin-top:2px;text-align:center;}
.overlay{
  position:absolute;inset:0;z-index:90;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.overlay.show{opacity:1;pointer-events:all;}
.ov-bg{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);}
.ov-card{
  position:relative;background:#fffde7;
  border:6px solid #ff6600;border-radius:22px;
  padding:24px 36px;text-align:center;
  box-shadow:0 8px 32px rgba(0,0,0,.4),4px 4px 0 #cc4400;
  min-width:50%;
}
.ov-card h2{font-size:clamp(1.3rem,3.5vw,2.2rem);font-weight:900;margin-bottom:6px;}
.ov-card .sub{font-size:clamp(.75rem,1.7vw,1rem);color:#666;margin-bottom:18px;}
.btn{
  background:linear-gradient(180deg,#ff9900,#ff6600);
  border:none;border-radius:40px;color:#fff;
  font-family:'Zen Maru Gothic',sans-serif;
  font-size:clamp(.85rem,1.8vw,1.1rem);font-weight:900;
  padding:11px 34px;cursor:pointer;
  box-shadow:0 4px 0 #cc3300,0 6px 14px rgba(0,0,0,.3);
  transition:transform .1s;letter-spacing:.05em;
}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:translateY(2px);box-shadow:0 2px 0 #cc3300;}
.ptcl{
  position:absolute;font-size:1.4rem;pointer-events:none;z-index:80;
  animation:ptcl-fly .9s forwards;
}
@keyframes ptcl-fly{
  0%{opacity:1;transform:translate(0,0) scale(1);}
  100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(.2);}
}
.red-flash{
  position:absolute;inset:0;background:rgba(255,0,0,.35);z-index:85;
  animation:flash-out .7s forwards;pointer-events:none;
}
@keyframes flash-out{0%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<div class="frame">
  <div class="scene" id="scene">
    <img class="bg-img" src="resources/images/bg.jpg" alt="ËÉåÊôØ">

    <div class="hud-timer">
      <div class="timer-label">„ÅÆ„Åì„Çä„Åò„Åã„Çì</div>
      <div class="timer-row">
        <span class="timer-num" id="tnum">60</span>
        <span class="timer-unit">„Å≥„Çá„ÅÜ</span>
      </div>
    </div>
    <div class="hud-stage" id="stage-el">„Çπ„ÉÜ„Éº„Ç∏ 1</div>
    <div class="hud-target">
      <div class="target-bubble">„Å©„Éº„Åì„Å†Ôºü</div>
      <div class="target-preview"><img src="resources/images/anpan.png" alt="„Ç¢„É≥„Éë„É≥„Éû„É≥"></div>
      <div class="target-name">„Ç¢„É≥„Éë„É≥„Éû„É≥</div>
    </div>

    <div class="overlay" id="ov-time">
      <div class="ov-bg"></div>
      <div class="ov-card">
        <h2 style="color:#cc2200">‚è∞ „Åò„Åã„Çì„Åé„ÇåÔºÅ</h2>
        <div class="sub" id="ov-time-sub"></div>
        <button class="btn" style="background:linear-gradient(180deg,#4499ff,#2266dd);box-shadow:0 4px 0 #0033aa" onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ üîÑ</button>
      </div>
    </div>
  </div>
</div>

<script>
const CHARS = {
  anpanman:    { name:'„Ç¢„É≥„Éë„É≥„Éû„É≥',   src:'resources/images/anpan.png' },
  baikinman:   { name:'„Éê„Ç§„Ç≠„É≥„Éû„É≥',   src:'resources/images/baikin.png' },
  batako:      { name:'„Éê„Çø„Ç≥„Åï„Çì',     src:'resources/images/batako.png' },
  cheese:      { name:'„ÉÅ„Éº„Ç∫',         src:'resources/images/chize.png' },
  dokinchan:   { name:'„Éâ„Ç≠„É≥„Å°„ÇÉ„Çì',   src:'resources/images/dokin.png' },
  jamojisan:   { name:'„Ç∏„É£„É†„Åä„Åò„Åï„Çì', src:'resources/images/jam.png' },
  currypanman: { name:'„Ç´„É¨„Éº„Éë„É≥„Éû„É≥', src:'resources/images/kare-.png' },
  kokinchan:   { name:'„Ç≥„Ç≠„É≥„Å°„ÇÉ„Çì',   src:'resources/images/kokin.png' },
  melonpanna:  { name:'„É°„É≠„É≥„Éë„É≥„Éä',   src:'resources/images/meron.png' },
  rollpanna:   { name:'„É≠„Éº„É´„Éë„É≥„Éä',   src:'resources/images/roll.png' },
  shokupanman: { name:'„Åó„Çá„Åè„Å±„Çì„Åæ„Çì', src:'resources/images/shokupan.png' },
};

const NOISE = ['baikinman','batako','cheese','dokinchan','jamojisan',
               'currypanman','kokinchan','melonpanna','rollpanna','shokupanman'];

const STAGE_CONFIGS = [
  { time:60, count:9,  cols:3, label:'„Çπ„ÉÜ„Éº„Ç∏ 1 / 5' },
  { time:55, count:12, cols:4, label:'„Çπ„ÉÜ„Éº„Ç∏ 2 / 5' },
  { time:50, count:15, cols:5, label:'„Çπ„ÉÜ„Éº„Ç∏ 3 / 5' },
  { time:45, count:18, cols:6, label:'„Çπ„ÉÜ„Éº„Ç∏ 4 / 5' },
  { time:40, count:22, cols:6, label:'„Çπ„ÉÜ„Éº„Ç∏ 5 / 5' },
];

const AUDIO = {
  bgm: new Audio('resources/sounds/bgm.wav'),
  start: new Audio('resources/sounds/start_voice.m4a'),
  correct: new Audio('resources/sounds/correct.m4a'),
};
AUDIO.bgm.loop = true;
const TOTAL_TIME = 60;
let audioUnlocked = false;
let pendingStageStartVoice = false;

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

function buildLayout(cfg){
  const {count,cols}=cfg;
  const rows=Math.ceil(count/cols);
  const x0=22,x1=88,y0=12,y1=84;
  const cellW=(x1-x0)/cols, cellH=(y1-y0)/rows;
  const charSize=Math.min(cellW*.72,cellH*.72,14);
  let noisePool=shuffle([...NOISE,...NOISE,...NOISE]).slice(0,count-1);
  const targetPos=Math.floor(Math.random()*count);
  const positions=[];
  let ni=0;
  for(let i=0;i<count;i++){
    const col=i%cols,row=Math.floor(i/cols);
    const bx=x0+col*cellW,by=y0+row*cellH;
    const ox=(Math.random()-.5)*cellW*.35;
    const oy=(Math.random()-.5)*cellH*.35;
    const x=Math.max(x0,Math.min(x1-charSize,bx+ox));
    const y=Math.max(y0,Math.min(y1-charSize,by+oy));
    const isTarget=(i===targetPos);
    const id=isTarget?'anpanman':noisePool[ni++];
    positions.push({id,x,y,s:charSize,isTarget});
  }
  return positions;
}

let stage=0,timeLeft=TOTAL_TIME,timer=null,answered=false,gameOver=false;

function unlockAudio(){
  if(audioUnlocked){
    if(AUDIO.bgm.paused) AUDIO.bgm.play().catch(()=>{});
    return;
  }
  AUDIO.bgm.play()
    .then(()=>{
      audioUnlocked = true;
      if(pendingStageStartVoice){
        pendingStageStartVoice = false;
        playStageStartVoice();
      }
    })
    .catch(()=>{});
}

function playStageStartVoice(){
  if(!audioUnlocked){
    pendingStageStartVoice = true;
    return;
  }
  AUDIO.start.currentTime = 0;
  AUDIO.start.play().catch(()=>{});
}

function playCorrectVoice(){
  if(!audioUnlocked) return;
  AUDIO.correct.currentTime = 0;
  AUDIO.correct.play().catch(()=>{});
}

function loadStage(idx){
  if(gameOver) return;
  unlockAudio();
  playStageStartVoice();
  answered=false;
  const cfg=STAGE_CONFIGS[Math.min(idx,STAGE_CONFIGS.length-1)];
  document.querySelectorAll('.char,.ptcl,.red-flash').forEach(e=>e.remove());
  document.getElementById('stage-el').textContent='„Çπ„ÉÜ„Éº„Ç∏ '+(idx+1);
  updateTimerDisplay();
  const layout=buildLayout(cfg);
  const scene=document.getElementById('scene');
  layout.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='char';
    div.style.cssText=`left:${p.x.toFixed(1)}%;top:${p.y.toFixed(1)}%;width:${p.s.toFixed(1)}%;opacity:0;transition:opacity .3s ${i*.03}s`;
    const img=document.createElement('img');
    img.src=CHARS[p.id].src;
    img.alt=CHARS[p.id].name;
    div.appendChild(img);
    div.addEventListener('click',()=>handleTap(div,p.isTarget));
    div.addEventListener('touchstart',e=>{e.preventDefault();handleTap(div,p.isTarget);},{passive:false});
    scene.appendChild(div);
    requestAnimationFrame(()=>div.style.opacity='1');
  });
  document.getElementById('ov-time').classList.remove('show');
}

function updateTimerDisplay(){
  const el=document.getElementById('tnum');
  el.textContent=timeLeft;
  el.className='timer-num'+(timeLeft<=10?' warn':'');
}

function handleTap(el,isTarget){
  unlockAudio();
  if(answered||!isTarget)return;
  answered=true;
  playCorrectVoice();
  el.classList.add('correct');
  spawnParticles(el);
  setTimeout(nextStage,1000);
}

function spawnParticles(fromEl){
  const fr=document.querySelector('.frame').getBoundingClientRect();
  const er=fromEl.getBoundingClientRect();
  const cx=((er.left+er.width/2)-fr.left)/fr.width*100;
  const cy=((er.top+er.height/2)-fr.top)/fr.height*100;
  const ems=['‚≠ê','‚ú®','üéâ','üí´','üåü','üéä','üéà'];
  const scene=document.getElementById('scene');
  for(let i=0;i<14;i++){
    const p=document.createElement('div');
    p.className='ptcl';p.textContent=ems[i%ems.length];
    p.style.left=cx+'%';p.style.top=cy+'%';
    const a=Math.PI*2*i/14+Math.random()*.5,d=80+Math.random()*110;
    p.style.setProperty('--dx',Math.cos(a)*d+'px');
    p.style.setProperty('--dy',Math.sin(a)*d+'px');
    p.style.animationDelay=Math.random()*.15+'s';
    scene.appendChild(p);
    setTimeout(()=>p.remove(),1100);
  }
}

function showTimeOver(){
  if(gameOver) return;
  gameOver=true;
  answered=true;
  clearInterval(timer);
  AUDIO.bgm.pause();
  const f=document.createElement('div');f.className='red-flash';
  document.getElementById('scene').appendChild(f);
  setTimeout(()=>f.remove(),800);
  document.getElementById('ov-time-sub').textContent='Âà∞ÈÅî„Çπ„ÉÜ„Éº„Ç∏: '+(stage+1);
  setTimeout(()=>document.getElementById('ov-time').classList.add('show'),400);
}

function nextStage(){
  if(gameOver) return;
  stage++;loadStage(stage);
}

function startGame(){
  gameOver=false;
  stage=0;
  timeLeft=TOTAL_TIME;
  document.getElementById('ov-time').classList.remove('show');
  clearInterval(timer);
  timer=setInterval(()=>{
    if(gameOver) return;
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft<=0)showTimeOver();
  },1000);
  loadStage(stage);
}

function restartGame(){
  startGame();
}
window.addEventListener('pointerdown', unlockAudio, { passive:true });
window.addEventListener('load',startGame);
</script>
</body>
</html>
